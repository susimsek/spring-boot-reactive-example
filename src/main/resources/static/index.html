<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Todo App</title>
  <!-- Bootstrap & Font Awesome -->
  <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/webjars/font-awesome/css/all.min.css" rel="stylesheet">
  <!-- LiveReload (optional) -->
  <script src="http://localhost:35729/livereload.js"></script>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <style>
    html, body {
      height: 100%;
    }
    body {
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
    }
    /* Main content flex: 1 will push footer to the bottom */
    .main-content {
      flex: 1;
    }
    /* Table container styling (desktop) */
    #tableContainer {
      background-color: #fff;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    /* Card container styling (mobile) */
    #cardContainer .card {
      margin-bottom: 1rem;
    }
    /* Pagination container styling */
    .pagination-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 0.5rem;
      background-color: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    .pagination-container .page-size {
      margin-left: 1rem;
    }
    .navbar {
      background-color: #ffffff;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    /* Responsive: small screens */
    @media (max-width: 576px) {
      .pagination-container {
        flex-direction: column;
      }
      .pagination-container .page-size {
        margin-left: 0;
      }
    }
    /* Sticky Footer styling */
    footer {
      background-color: #ffffff;
      box-shadow: 0 -0.125rem 0.25rem rgba(0,0,0,0.075);
      padding: 1rem 0;
    }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img src="/logo.png" alt="Logo" width="30" height="30" class="d-inline-block align-top">
      Todo App
    </a>
  </div>
</nav>

<!-- Main content -->
<div class="main-content container my-4">
  <!-- Header & Create Button -->
  <div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Todo List</h2>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal" type="button">
        <i class="fas fa-plus"></i> Create New Todo
      </button>
    </div>
  </div>

  <!-- Desktop Table View (visible on sm and up) -->
  <div id="tableContainer" class="d-none d-sm-block">
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="todoTable">
        <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Completed</th>
          <th>Created At</th>
          <th>Updated At</th>
          <th class="text-end">Actions</th>
        </tr>
        </thead>
        <tbody>
        <!-- Table rows will be injected here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Mobile Card View (visible on xs) -->
  <div id="cardContainer" class="d-block d-sm-none">
    <!-- Card items will be injected here -->
  </div>

  <!-- Pagination & Page Size Section -->
  <div class="pagination-container">
    <nav aria-label="Todo pagination">
      <ul class="pagination mb-0" id="paginationControls">
        <!-- Pagination controls rendered via JavaScript -->
      </ul>
    </nav>
    <div class="page-size">
      <div class="input-group">
        <span class="input-group-text" id="pageSizeLabel">Size</span>
        <select class="form-select" id="pageSizeSelect" aria-label="Page size">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- CREATE Todo Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="createForm">
      <div class="modal-header">
        <h5 class="modal-title" id="createModalLabel">Create New Todo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="createTitle" class="form-label">Title</label>
          <input type="text" class="form-control" id="createTitle" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> Create
        </button>
      </div>
    </form>
  </div>
</div>

<!-- UPDATE Todo Modal (Full Update / PUT) -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="updateForm">
      <div class="modal-header">
        <h5 class="modal-title" id="updateModalLabel">Update Todo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="updateId">
        <div class="mb-3">
          <label for="updateTitle" class="form-label">Title</label>
          <input type="text" class="form-control" id="updateTitle" required>
        </div>
        <div class="mb-3">
          <label for="updateCompleted" class="form-label">Completed?</label>
          <select class="form-select" id="updateCompleted" required>
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-warning">
          <i class="fas fa-edit"></i> Update
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal for Delete -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmModalBody">
        <!-- Confirmation message set dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="confirmCancelBtn" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmOkBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Footer (Sticky) -->
<footer class="text-center">
  <div class="container">
    <p class="mb-0">&copy; 2025 Todo App. All rights reserved.</p>
  </div>
</footer>

<!-- Bootstrap Bundle JS (includes Popper) -->
<script src="/webjars/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script>
  let totalPages = 10;
  let currentPage = 0;
  let pageSize = 10;
  const baseUrl = '/api/v1/todos';

  const todoTableBody = document.querySelector('#todoTable tbody');
  const cardContainer = document.getElementById('cardContainer');
  const createForm = document.getElementById('createForm');
  const createTitleInput = document.getElementById('createTitle');

  const updateModalEl = document.getElementById('updateModal');
  const updateModal = new bootstrap.Modal(updateModalEl);
  const updateForm = document.getElementById('updateForm');
  const updateIdInput = document.getElementById('updateId');
  const updateTitleInput = document.getElementById('updateTitle');
  const updateCompletedSelect = document.getElementById('updateCompleted');

  const pageSizeSelect = document.getElementById('pageSizeSelect');
  const paginationControls = document.getElementById('paginationControls');

  async function fetchTodos() {
    try {
      const res = await fetch(`${baseUrl}?page=${currentPage}&size=${pageSize}`);
      if (!res.ok) throw new Error('Failed to fetch todos');
      const todos = await res.json();
      renderTodos(todos);
      if (todos.length < pageSize) {
        totalPages = currentPage + 1;
      }
      updatePaginationControls();
    } catch (err) {
      console.error(err);
    }
  }

  function renderTodos(todos) {
    todoTableBody.innerHTML = '';
    cardContainer.innerHTML = '';

    todos.forEach(todo => {
      const row = document.createElement('tr');
      row.innerHTML = `
          <td>${todo.id}</td>
          <td>${todo.title}</td>
          <td>
            ${todo.completed ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'}
          </td>
          <td>${formatDate(todo.createdAt)}</td>
          <td>${formatDate(todo.updatedAt)}</td>
          <td class="text-end">
            <div class="btn-group" role="group" aria-label="Actions">
              <button type="button" class="btn btn-secondary btn-sm" onclick="markAsComplete(${todo.id})" title="Mark as Completed">
                <i class="fas fa-check-circle"></i>
              </button>
              <button type="button" class="btn btn-warning btn-sm" onclick="openUpdateModal(${todo.id})" title="Full Update">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm" onclick="deleteTodo(${todo.id})" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
      todoTableBody.appendChild(row);

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${todo.title}</h5>
            <p class="card-text mb-1"><strong>ID:</strong> ${todo.id}</p>
            <p class="card-text mb-1"><strong>Completed:</strong> ${todo.completed ? 'Yes' : 'No'}</p>
            <p class="card-text mb-1"><strong>Created:</strong> ${formatDate(todo.createdAt)}</p>
            <p class="card-text mb-3"><strong>Updated:</strong> ${formatDate(todo.updatedAt)}</p>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-secondary btn-sm" onclick="markAsComplete(${todo.id})">
                <i class="fas fa-check-circle"></i>
              </button>
              <button type="button" class="btn btn-warning btn-sm" onclick="openUpdateModal(${todo.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="btn btn-danger btn-sm" onclick="deleteTodo(${todo.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      cardContainer.appendChild(card);
    });
  }

  function updatePaginationControls() {
    let html = '';

    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
        <button type="button" class="page-link" onclick="goToPage(0)" aria-label="First">
          <i class="fas fa-angle-double-left"></i>
        </button>
      </li>`;

    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
        <button type="button" class="page-link" onclick="goToPage(${currentPage - 1})" aria-label="Previous">
          <i class="fas fa-chevron-left"></i>
        </button>
      </li>`;

    html += `<li class="page-item active">
        <span class="page-link">${currentPage + 1}</span>
      </li>`;

    html += `<li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
        <button type="button" class="page-link" onclick="goToPage(${currentPage + 1})" aria-label="Next">
          <i class="fas fa-chevron-right"></i>
        </button>
      </li>`;

    html += `<li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
        <button type="button" class="page-link" onclick="goToPage(${totalPages - 1})" aria-label="Last">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </li>`;

    paginationControls.innerHTML = html;
  }

  window.goToPage = function(page) {
    if (page < 0 || page >= totalPages) return;
    currentPage = page;
    fetchTodos();
  };

  function formatDate(isoString) {
    if (!isoString) return '';
    return new Date(isoString).toLocaleString();
  }

  createForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const title = createTitleInput.value.trim();
    if (!title) return;
    const newTodo = { title };
    try {
      const res = await fetch(baseUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newTodo)
      });
      if (res.status === 201) {
        bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
        createForm.reset();
        currentPage = 0;
        fetchTodos();
      } else {
        throw new Error('Failed to create todo');
      }
    } catch (err) {
      console.error(err);
    }
  });

  async function openUpdateModal(id) {
    try {
      const res = await fetch(`${baseUrl}/${id}`);
      if (!res.ok) {
        if (res.status === 404) throw new Error('Todo not found');
        throw new Error('Failed to fetch todo by ID');
      }
      const todo = await res.json();
      updateIdInput.value = todo.id;
      updateTitleInput.value = todo.title;
      updateCompletedSelect.value = todo.completed ? 'true' : 'false';
      updateModal.show();
    } catch (err) {
      console.error(err);
    }
  }

  updateForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = updateIdInput.value;
    const title = updateTitleInput.value.trim();
    const completed = updateCompletedSelect.value === 'true';
    if (!id || !title) return;
    const updatedTodo = { title, completed };
    try {
      const res = await fetch(`${baseUrl}/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedTodo)
      });
      if (!res.ok) {
        if (res.status === 404) throw new Error('Todo not found');
        throw new Error('Failed to update todo');
      }
      updateModal.hide();
      fetchTodos();
    } catch (err) {
      console.error(err);
    }
  });

  async function markAsComplete(id) {
    try {
      const patchData = { completed: true };
      const res = await fetch(`${baseUrl}/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patchData)
      });
      if (!res.ok) {
        if (res.status === 404) throw new Error('Todo not found');
        throw new Error('Failed to patch todo');
      }
      fetchTodos();
    } catch (err) {
      console.error(err);
    }
  }

  function showConfirmModal(message) {
    return new Promise((resolve) => {
      const confirmModalEl = document.getElementById('confirmModal');
      const confirmModal = new bootstrap.Modal(confirmModalEl);
      document.getElementById('confirmModalBody').textContent = message;

      const okButton = document.getElementById('confirmOkBtn');
      const cancelButton = document.getElementById('confirmCancelBtn');

      const cleanUp = () => {
        okButton.replaceWith(okButton.cloneNode(true));
        cancelButton.replaceWith(cancelButton.cloneNode(true));
      };

      const newOkButton = document.getElementById('confirmOkBtn');
      const newCancelButton = document.getElementById('confirmCancelBtn');

      newOkButton.addEventListener('click', () => {
        cleanUp();
        confirmModal.hide();
        resolve(true);
      });

      newCancelButton.addEventListener('click', () => {
        cleanUp();
        confirmModal.hide();
        resolve(false);
      });

      confirmModal.show();
    });
  }

  async function deleteTodo(id) {
    const confirmed = await showConfirmModal(`Are you sure you want to delete Todo #${id}?`);
    if (!confirmed) return;
    try {
      const res = await fetch(`${baseUrl}/${id}`, { method: 'DELETE' });
      if (res.status === 204) {
        fetchTodos();
      } else if (res.status === 404) {
        throw new Error('Todo not found');
      } else {
        throw new Error('Failed to delete todo');
      }
    } catch (err) {
      console.error(err);
    }
  }

  pageSizeSelect.addEventListener('change', () => {
    pageSize = parseInt(pageSizeSelect.value);
    currentPage = 0;
    fetchTodos();
  });

  document.addEventListener('DOMContentLoaded', fetchTodos);
</script>
</body>
</html>
